<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Bern's 100 Days Transformation</title>
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="https://via.placeholder.com/180x180/ef4444/ffffff?text=B100">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f4f7f9; }
        .tab-button.active { border-bottom: 3px solid #ef4444; color: #ef4444; }
        .day-button.active { background-color: #ef4444; color: white; }
        .snapshot-target { background-color: #ffffff; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1); }
        /* Hide default number input arrows */
        input[type="number"]::-webkit-outer-spin-button,
        input[type="number"]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type="number"] {
            -moz-appearance: textfield;
        }
        .progress-bar-container {
            width: 100%;
            background-color: #e5e7eb;
            border-radius: 9999px;
            overflow: hidden;
            height: 1rem;
        }
        .progress-bar {
            height: 100%;
            transition: width 0.3s ease-in-out;
        }
        /* Fix for iOS viewport (if needed) */
        #app {
            padding-bottom: constant(safe-area-inset-bottom);
            padding-bottom: env(safe-area-inset-bottom);
        }
    </style>
</head>
<body class="min-h-screen p-0 md:p-4">

    <div id="app" class="max-w-xl mx-auto bg-white rounded-lg shadow-2xl overflow-hidden min-h-screen md:min-h-0">
        <header class="bg-gray-800 p-4 text-white rounded-t-lg">
            <h1 class="text-2xl font-bold text-center">Bern's 100 Days Transformation</h1>
            <div id="day-counter" class="mt-2 text-lg font-semibold text-center"></div>
            
            <div class="mt-3 flex flex-wrap items-center justify-center space-x-4">
                
                <div class="flex items-center space-x-2 my-1">
                    <label for="goal-selector" class="text-sm font-medium">Goal:</label>
                    <select id="goal-selector" class="bg-white text-gray-800 text-sm rounded-md py-1 px-2 focus:ring-red-500 focus:border-red-500" onchange="updateGoal(this.value)">
                        <option value="cutting">üî™ Cutting</option>
                        <option value="bulking">üí™ Bulking</option>
                        <option value="recomp">‚ú® Recomposition</option>
                    </select>
                </div>
                
                <div class="flex items-center space-x-2 my-1">
                    <label for="gender-selector" class="text-sm font-medium">Gender:</label>
                    <select id="gender-selector" class="bg-white text-gray-800 text-sm rounded-md py-1 px-2 focus:ring-red-500 focus:border-red-500" onchange="updateGender(this.value)">
                        <option value="male">üë§ Male</option>
                        <option value="female">‚ôÄÔ∏è Female</option>
                    </select>
                </div>

            </div>
             <p id="goal-tip" class="text-xs text-center mt-2 h-4 transition-opacity duration-300"></p>
        </header>

        <div id="day-selector-container" class="w-full bg-gray-100 p-2 overflow-x-scroll whitespace-nowrap border-b border-gray-200">
            </div>

        <div class="flex border-b border-gray-200 bg-gray-50">
             <button class="tab-button flex-1 py-3 text-sm font-semibold transition duration-150 active" data-tab="summary">
                üìã Summary
            </button>
            <button class="tab-button flex-1 py-3 text-sm font-semibold transition duration-150" data-tab="exercise">
                üí™ Workout
            </button>
            <button class="tab-button flex-1 py-3 text-sm font-semibold transition duration-150" data-tab="food">
                üçé Food
            </button>
            <button class="tab-button flex-1 py-3 text-sm font-semibold transition duration-150" data-tab="steps">
                üö∂ Steps
            </button>
        </div>

        <main class="p-4 md:p-6">
            
             <div id="summary" class="tab-content">
                <div id="daily-summary-tracker" class="snapshot-target p-4 mb-6">
                    <h2 class="text-2xl font-extrabold text-gray-800 mb-4 text-center">Daily Progress Snapshot</h2>
                    <p class="text-sm text-gray-500 mb-6 text-center">Goal: <span id="summary-goal-text" class="font-bold text-red-500"></span> | Gender: <span id="summary-gender-text" class="font-bold text-indigo-500"></span></p>

                    <div class="mb-6 p-4 border rounded-lg shadow-sm">
                        <h3 class="text-xl font-bold text-emerald-600 mb-3 flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6 mr-2"><path d="M15 12a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z" /><path fill-rule="evenodd" d="M12 1.5a5.25 5.25 0 0 0-5.25 5.25v3a3 3 0 0 0-3 3v6.75a3 3 0 0 0 3 3h1.5a.75.75 0 0 0 .75-.75V15a.75.75 0 0 1 .75-.75h2.25a.75.75 0 0 1 .75.75v4.5c0 .414.336.75.75.75h1.5a3 3 0 0 0 3-3V12.75a3 3 0 0 0-3-3v-3c0-2.9-2.35-5.25-5.25-5.25Z" clip-rule="evenodd" /></svg>
                            Step Progress
                        </h3>
                        <div class="flex justify-between font-medium text-sm mb-1">
                            <span>Actual: <span id="summary-steps-actual" class="font-extrabold">0</span> steps</span>
                            <span>Goal: <span id="summary-steps-goal" class="font-extrabold text-emerald-600">0</span> steps</span>
                        </div>
                        <div class="progress-bar-container">
                            <div id="progress-steps" class="progress-bar bg-emerald-500" style="width: 0%;"></div>
                        </div>
                         <p class="text-xs text-gray-500 mt-2">Steps Cal Burn: <span id="summary-steps-kcal">0 kcal</span></p>
                    </div>

                    <div class="mb-6 p-4 border rounded-lg shadow-sm">
                        <h3 class="text-xl font-bold text-indigo-600 mb-3 flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6 mr-2"><path fill-rule="evenodd" d="M12 1.5a.75.75 0 0 1 .75.75V3h3a6 6 0 0 1 6 6v3h.75a.75.75 0 0 1 0 1.5H21v3a6 6 0 0 1-6 6h-3.75a.75.75 0 0 1-.75-.75V21h-3a6 6 0 0 1-6-6v-3H2.25a.75.75 0 0 1 0-1.5H3V9a6 6 0 0 1 6-6h3V2.25a.75.75 0 0 1 .75-.75ZM9 4.5h3A4.5 4.5 0 0 1 16.5 9v3h-1.5a.75.75 0 0 0-.75.75v3a.75.75 0 0 1-.75.75h-2.25a.75.75 0 0 1-.75-.75v-3a.75.75 0 0 0-.75-.75H7.5V9A4.5 4.5 0 0 1 12 4.5h3v1.5a.75.75 0 0 0 1.5 0V6a4.5 4.5 0 0 0-4.5-4.5h-3A4.5 4.5 0 0 0 7.5 6v3a.75.75 0 0 0 1.5 0V6a4.5 4.5 0 0 0-4.5 4.5v3a.75.75 0 0 0 1.5 0V12a.75.75 0 0 0-.75-.75h-1.5V9a4.5 4.5 0 0 1 4.5-4.5Z" clip-rule="evenodd" /></svg>
                            Workout Status
                        </h3>
                         <p id="summary-workout-type" class="text-lg font-semibold text-gray-700 mb-2"></p>
                         <p id="summary-workout-sets" class="text-sm text-gray-500 mb-2"></p>
                         <p class="text-md font-semibold text-gray-700">Estimated Kcal Burned:</p>
                         <p id="summary-workout-kcal" class="text-2xl font-extrabold text-indigo-500 mt-1">0 kcal</p>
                    </div>

                    <div class="p-4 border rounded-lg shadow-sm">
                        <h3 class="text-xl font-bold text-red-600 mb-3 flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6 mr-2"><path fill-rule="evenodd" d="M12 2.25c-5.385 0-9.75 4.365-9.75 9.75s4.365 9.75 9.75 9.75 9.75-4.365 9.75-9.75S17.385 2.25 12 2.25ZM12.75 6a.75.75 0 0 0-1.5 0v6c0 .414.336.75.75.75h4.5a.75.75 0 0 0 0-1.5h-3.75V6Z" clip-rule="evenodd" /></svg>
                            Nutrition Intake
                        </h3>
                        <div id="summary-macro-goals" class="grid grid-cols-4 gap-2 text-center text-sm font-semibold mb-3 border-b pb-2">
                             <span class="text-red-500">KCAL Target: 0</span>
                             <span class="text-blue-500">P Target: 0g</span>
                             <span class="text-green-500">C Target: 0g</span>
                             <span class="text-yellow-500">F Target: 0g</span>
                        </div>
                        <div id="summary-macro-actuals" class="grid grid-cols-4 gap-2 text-center text-sm font-bold">
                            <span class="text-gray-700">Actual KCAL: <span id="actual-kcal">0</span></span>
                            <span class="text-gray-700">Actual P: <span id="actual-protein">0</span>g</span>
                            <span class="text-gray-700">Actual C: <span id="actual-carbs">0</span>g</span>
                            <span class="text-gray-700">Actual F: <span id="actual-fat">0</span>g</span>
                        </div>
                    </div>
                </div>
                 <button onclick="handleSnapshot('daily-summary-tracker')" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 rounded-xl transition duration-300 shadow-md flex items-center justify-center">
                    Download Day Snapshot üì∏
                </button>
            </div>


            <div id="exercise" class="tab-content hidden">
                <div id="exercise-tracker" class="snapshot-target p-4 mb-6">
                    <h2 id="workout-title" class="text-xl font-bold text-gray-800 mb-4 text-center"></h2>
                    <p class="text-sm text-gray-500 mb-4 text-center">Log weight (kg) and reps for each set. Tick if completed (Progressive Overload).</p>
                    <div id="workout-list">
                        </div>
                    <div class="mt-6 pt-4 border-t border-dashed border-gray-300">
                        <p class="text-lg font-semibold text-gray-700">Total Calories Burned (Estimate):</p>
                        <p id="total-calories-burned" class="text-2xl font-extrabold text-red-500 mt-1">0 kcal</p>
                    </div>
                </div>
                <button onclick="handleSnapshot('exercise-tracker')" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 rounded-xl transition duration-300 shadow-md flex items-center justify-center">
                    Download Workout Snapshot üì∏
                </button>
            </div>

            <div id="food" class="tab-content hidden">
                <div id="food-tracker" class="snapshot-target p-4 mb-6">
                    <h2 class="text-xl font-bold text-gray-800 mb-4 text-center">Daily Food Intake</h2>
                    <form id="food-form" class="space-y-3">
                        <div>
                            <label for="food-name" class="block text-sm font-medium text-gray-700">Food Item Name (e.g., MyFitnessPal entry)</label>
                            <input type="text" id="food-name" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border focus:ring-red-500 focus:border-red-500" placeholder="e.g., Chicken Breast, 200g">
                        </div>
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label for="food-calories" class="block text-sm font-medium text-gray-700">Calories (kcal)</label>
                                <input type="number" id="food-calories" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border focus:ring-red-500 focus:border-red-500" placeholder="300">
                            </div>
                            <div>
                                <label for="food-protein" class="block text-sm font-medium text-gray-700">Protein (g)</label>
                                <input type="number" id="food-protein" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border focus:ring-red-500 focus:border-red-500" placeholder="30">
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label for="food-carbs" class="block text-sm font-medium text-gray-700">Carbs (g)</label>
                                <input type="number" id="food-carbs" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border focus:ring-red-500 focus:border-red-500" placeholder="25">
                            </div>
                            <div>
                                <label for="food-fat" class="block text-sm font-medium text-gray-700">Fat (g)</label>
                                <input type="number" id="food-fat" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border focus:ring-red-500 focus:border-red-500" placeholder="10">
                            </div>
                        </div>
                        <button type="submit" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 rounded-lg transition duration-300 shadow-md">
                            Add Meal/Food
                        </button>
                    </form>

                    <div class="mt-6">
                        <h3 class="text-lg font-bold text-gray-800 border-b pb-2 mb-2">Selected Day's Log</h3>
                        <div id="food-log" class="space-y-2 text-sm">
                            </div>
                        <div class="mt-4 pt-2 border-t border-dashed border-gray-300">
                            <p class="text-md font-semibold text-gray-700">Daily Totals:</p>
                            <div class="grid grid-cols-4 gap-2 text-center text-xs mt-1 font-bold">
                                <p class="text-red-500">KCAL: <span id="total-kcal">0</span></p>
                                <p class="text-blue-500">P: <span id="total-protein">0</span>g</p>
                                <p class="text-green-500">C: <span id="total-carbs">0</span>g</p>
                                <p class="text-yellow-500">F: <span id="total-fat">0</span>g</p>
                            </div>
                        </div>
                    </div>
                </div>
                <button onclick="handleSnapshot('food-tracker')" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 rounded-xl transition duration-300 shadow-md flex items-center justify-center">
                    Download Food Snapshot üì∏
                </button>
            </div>

            <div id="steps" class="tab-content hidden">
                <div id="steps-tracker" class="snapshot-target p-4 mb-6 text-center">
                    <h2 class="text-xl font-bold text-gray-800 mb-4">Daily Step Count</h2>
                    <p class="text-sm text-gray-500 mb-4">Log your total steps and the calories estimated by your device (or let us calculate it).</p>
                    <p id="recommended-steps" class="text-lg font-semibold text-emerald-600 mb-4"></p>
                    <form id="steps-form" class="space-y-4 max-w-sm mx-auto">
                        <div>
                            <label for="step-count" class="block text-lg font-medium text-gray-700">Total Steps Logged</label>
                            <input type="number" id="step-count" class="mt-1 block w-full text-center text-xl rounded-md border-gray-300 shadow-sm p-3 border focus:ring-red-500 focus:border-red-500" placeholder="e.g., 10000">
                        </div>
                        <div>
                            <label for="step-calories" class="block text-lg font-medium text-gray-700">Calories Burned (Estimated)</label>
                            <input type="number" id="step-calories" class="mt-1 block w-full text-center text-xl rounded-md border-gray-300 shadow-sm p-3 border focus:ring-red-500 focus:border-red-500" placeholder="e.g., 500 (Optional)">
                        </div>
                        <button type="submit" class="w-full bg-emerald-500 hover:bg-emerald-600 text-white font-bold py-3 rounded-xl transition duration-300 shadow-md">
                            Log Steps
                        </button>
                    </form>
                </div>
                <button onclick="handleSnapshot('steps-tracker')" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 rounded-xl transition duration-300 shadow-md flex items-center justify-center">
                    Download Steps Snapshot üì∏
                </button>
            </div>
        </main>
    </div>

    <div id="snapshot-footer" class="hidden text-xs text-gray-500 text-center w-full py-1 bg-gray-100 rounded-b-lg">
        Snapshot taken on <span id="snapshot-date"></span>
    </div>
    
    <div id="error-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white p-6 rounded-xl shadow-2xl max-w-sm w-full text-center">
            <h3 class="text-xl font-bold text-red-600 mb-4">Tracker Message</h3>
            <p id="error-message" class="text-gray-700 mb-6"></p>
            <button onclick="document.getElementById('error-modal').classList.add('hidden'); document.getElementById('error-modal').classList.remove('flex')" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg transition">
                Acknowledge & Continue
            </button>
        </div>
    </div>

    <script>
        // --- GLOBAL VARIABLES & CONSTANTS ---
        const DAY_COUNTER_KEY = 'berns100DaysStartDate';
        const GOAL_KEY = 'bernsCurrentGoal';
        const GENDER_KEY = 'bernsUserGender'; 
        const ALL_LOGS_KEY = 'bernsAll100DayLogs'; 
        const TOTAL_DAYS = 100;
        const EXERCISE_CALORIE_MULTIPLIER = 12; // Base kcal per set
        const WEIGHT_CALORIE_DIVISOR = 6;       // Bonus kcal per kg lifted
        const CAL_PER_STEP = 0.045;             // Estimated kcal per step

        let selectedDay = 1; 
        let allDailyLogs = {}; 
        let currentGoal = localStorage.getItem(GOAL_KEY) || 'cutting';
        let currentGender = localStorage.getItem(GENDER_KEY) || 'male'; 
        const todayKey = new Date().toISOString().split('T')[0]; 

        // New Consistency/Progression Phase constants
        const BASELINE_STEPS = 6000;
        const BASELINE_DAYS = 10;
        const PROGRESSION_DAYS = TOTAL_DAYS - BASELINE_DAYS; 

        // Goal based step targets
        const RECOMMENDED_STEPS = {
            cutting: 12000,
            bulking: 8000,
            recomp: 10000 
        };

        // Placeholder macro/calorie goals for the Summary tab
        const MACRO_GOALS = {
            cutting: { kcal: 2000, p_percent: 40, c_percent: 35, f_percent: 25 },
            bulking: { kcal: 3000, p_percent: 30, c_percent: 45, f_percent: 25 },
            recomp: { kcal: 2500, p_percent: 35, c_percent: 40, f_percent: 25 }
        };

        const GOAL_TIPS = {
            cutting: "üî™ **CUTTING:** Focus on **high protein** intake and a **calorie deficit** to preserve muscle while losing fat.",
            bulking: "üí™ **BULKING:** Ensure a consistent **calorie surplus** and fuel workouts with **carbs and protein** for maximal muscle growth.",
            recomp: "‚ú® **RECOMP:** Maintain calories and **maximize protein**. Eat slightly higher on workout days and lower on rest days."
        };
        
        // Define the common abs exercises once
        const ABS_EXERCISES = [
            { name: "Crunches / Leg Raises", sets: 3, majorGroup: "Abs/Core" },
            { name: "Plank (30-60s hold)", sets: 3, majorGroup: "Core Stability" }
        ];

        // MALE Workout Definitions (Lazy Lifter Basic)
        const WORKOUTS_MALE = {
            A: [
                { name: "Barbell Squat", sets: 3, majorGroup: "Legs/Core" },
                { name: "Bench Press", sets: 3, majorGroup: "Chest/Triceps" },
                { name: "Barbell Row", sets: 3, majorGroup: "Back/Biceps" },
                { name: "Overhead Press", sets: 3, majorGroup: "Shoulders/Triceps" },
                { name: "Bicep Curl (DB)", sets: 3, majorGroup: "Biceps (Accessory)" },
                ...ABS_EXERCISES
            ],
            B: [
                { name: "Deadlifts", sets: 3, majorGroup: "Back/Legs/Core" },
                { name: "Lat Pulldown/Pull-up", sets: 3, majorGroup: "Back/Biceps" },
                { name: "Incline DB Press", sets: 3, majorGroup: "Chest/Shoulders" },
                { name: "Leg Press/Lunges", sets: 3, majorGroup: "Legs" },
                { name: "Triceps Pushdown", sets: 3, majorGroup: "Triceps (Accessory)" },
                ...ABS_EXERCISES
            ]
        };

        // FEMALE Workout Definitions (Adapted Lazy Lifter Women's Basic - Glute/Hip Focus)
        const WORKOUTS_FEMALE = {
            A: [
                { name: "Barbell Squat", sets: 3, majorGroup: "Legs/Glutes" },
                { name: "Bench Press (DB/Machine)", sets: 3, majorGroup: "Chest/Triceps" },
                { name: "Barbell Row (Supported)", sets: 3, majorGroup: "Back/Biceps" },
                { name: "Hip Thrusts (Barbell)", sets: 3, majorGroup: "Glutes/Hips" }, 
                { name: "Lateral Raises (DB)", sets: 3, majorGroup: "Shoulders (Accessory)" }, 
                ...ABS_EXERCISES
            ],
            B: [
                { name: "Romanian Deadlifts", sets: 3, majorGroup: "Hamstrings/Glutes" }, 
                { name: "Lat Pulldown", sets: 3, majorGroup: "Back/Biceps" },
                { name: "Overhead Press (DB/Machine)", sets: 3, majorGroup: "Shoulders/Triceps" },
                { name: "Leg Extension / Curl (Superset)", sets: 3, majorGroup: "Legs (Quads/Hams)" }, 
                { name: "Face Pulls", sets: 3, majorGroup: "Shoulders/Back (Accessory)" }, 
                ...ABS_EXERCISES
            ]
        };

        // --- UTILITIES & LOCAL STORAGE MANAGEMENT ---
        
        function showErrorModal(message) {
            document.getElementById('error-message').innerHTML = message;
            document.getElementById('error-modal').classList.remove('hidden');
            document.getElementById('error-modal').classList.add('flex');
        }
        window.showErrorModal = showErrorModal;

        function saveAllLogs() {
            try {
                localStorage.setItem(ALL_LOGS_KEY, JSON.stringify(allDailyLogs));
            } catch (e) {
                console.error("Error saving all 100-day data:", e);
                showErrorModal("Failed to save data locally. Your browser storage may be full or disabled.");
            }
        }

        function loadAllLogs() {
            try {
                allDailyLogs = JSON.parse(localStorage.getItem(ALL_LOGS_KEY) || '{}');
            } catch (e) {
                console.error("Error loading all 100-day data:", e);
                showErrorModal("Failed to load all challenge logs. Resetting the tracker data.");
                allDailyLogs = {};
            }
        }

        function getLogForDay(day) {
            const dayStr = day.toString();
            if (!allDailyLogs[dayStr]) {
                allDailyLogs[dayStr] = {
                    foodLog: [], 
                    stepLog: { steps: '', calories: '' }, 
                    workoutLogs: {}
                };
            }
            return allDailyLogs[dayStr];
        }

        /**
         * Calculates the progressive step goal for a given day using a two-phase model.
         */
        function getDailyStepGoal(day, goal) {
            const finalGoalSteps = RECOMMENDED_STEPS[goal];

            // Phase 1: Habit Formation (Days 1 to 10) - Fixed Goal
            if (day <= BASELINE_DAYS) {
                return BASELINE_STEPS;
            }
            
            // Phase 2: Progressive Overload (Days 11 to 100) - Linear Increase
            if (day > BASELINE_DAYS && day <= TOTAL_DAYS) {
                const startProgression = BASELINE_STEPS;
                const totalIncrease = finalGoalSteps - startProgression; 
                const daysIntoProgression = day - BASELINE_DAYS; 
                
                // Linear interpolation over the 90 progression days
                let target = startProgression + (totalIncrease * (daysIntoProgression / PROGRESSION_DAYS));
                
                return Math.round(target / 100) * 100; // Round to nearest 100
            }
            
            // If day > 100, return the final goal
            return finalGoalSteps;
        }


        // --- DAY SELECTION & 100 DAY LOGIC ---

        function getChallengeDay() {
            let startDateStr = localStorage.getItem(DAY_COUNTER_KEY);
            
            if (!startDateStr) {
                startDateStr = todayKey;
                localStorage.setItem(DAY_COUNTER_KEY, startDateStr);
            }
            
            const today = new Date();
            today.setHours(0, 0, 0, 0); 
            
            let startDate = new Date(startDateStr);
            startDate.setHours(0, 0, 0, 0); 

            if (isNaN(startDate.getTime())) {
                startDate = today;
                startDateStr = todayKey;
                localStorage.setItem(DAY_COUNTER_KEY, startDateStr);
                showErrorModal("The challenge start date was corrupted. It has been automatically reset to today's date.");
            }

            const diffTime = today.getTime() - startDate.getTime();
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            
            return Math.min(diffDays + 1, TOTAL_DAYS);
        }

        function renderDaySelector() {
            const selectorContainer = document.getElementById('day-selector-container');
            selectorContainer.innerHTML = '';
            
            const challengeDay = getChallengeDay();
            const displayDate = new Date().toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
            
            if (challengeDay > TOTAL_DAYS) {
                document.getElementById('day-counter').innerHTML = `üéâ **100 Day Challenge Completed!**`;
            } else {
                document.getElementById('day-counter').innerHTML = `üìÖ ${displayDate} | **Challenge Day ${challengeDay}**`;
            }
            
            // Generate 100 buttons
            for (let day = 1; day <= TOTAL_DAYS; day++) {
                const button = document.createElement('button');
                button.textContent = `Day ${day}`;
                button.setAttribute('data-day', day);
                button.className = `day-button text-xs px-3 py-1 m-1 rounded-full font-semibold border border-gray-300 transition duration-150 ${day === selectedDay ? 'active' : 'bg-white text-gray-700 hover:bg-gray-200'}`;
                button.onclick = () => selectDay(day);
                selectorContainer.appendChild(button);
            }
            
            const activeDayButton = selectorContainer.querySelector('.day-button.active');
            if (activeDayButton) {
                activeDayButton.scrollIntoView({ behavior: 'smooth', inline: 'center' });
            }
        }

        window.selectDay = (day) => {
            selectedDay = day;
            renderAll();
        }


        // --- GOAL & GENDER SETTINGS ---
        window.updateGoal = (goal) => {
            currentGoal = goal;
            localStorage.setItem(GOAL_KEY, currentGoal);
            renderGoalTip();
            renderAll(); 
        };
        
        window.updateGender = (gender) => {
            currentGender = gender;
            localStorage.setItem(GENDER_KEY, currentGender);
            renderAll();
            showErrorModal(`Workout routine set to **${gender.toUpperCase()}** split.`);
        };

        function renderGoalTip() {
            document.getElementById('goal-selector').value = currentGoal;
            document.getElementById('gender-selector').value = currentGender;
            document.getElementById('goal-tip').innerHTML = GOAL_TIPS[currentGoal];
        }

        // --- EXERCISE TRACKING LOGIC ---

        function getCurrentWorkoutType(day) {
            // Lazy Lifter 3x/week split logic: Workouts on Day 1, 3, 5, 7, 9, 11, 13...
            // Use mod 4 to alternate A/B every two days
            const mod = (day - 1) % 4; 
            
            const routine = (currentGender === 'male') ? WORKOUTS_MALE : WORKOUTS_FEMALE;

            if (mod === 0 || mod === 2) { 
                const workoutKey = (day % 2 !== 0) ? 'A' : 'B';
                return { 
                    type: workoutKey, 
                    exercises: routine[workoutKey] 
                };
            }
            
            return { type: 'Rest Day', exercises: [] };
        }

        function calculateWorkoutKcal(workoutLogs) {
            let totalKcal = 0;
            let totalSetsCompleted = 0;
            let totalWeightLifted = 0;

            for (const exKey in workoutLogs) {
                if (workoutLogs.hasOwnProperty(exKey)) {
                    workoutLogs[exKey].forEach(logItem => {
                        if (logItem && logItem.done) {
                            totalSetsCompleted++;
                            const weight = parseFloat(logItem.kg) || 0;
                            const reps = parseInt(logItem.reps) || 0;
                            totalWeightLifted += weight * reps;
                        }
                    });
                }
            }

            totalKcal = (totalSetsCompleted * EXERCISE_CALORIE_MULTIPLIER) + (totalWeightLifted / WEIGHT_CALORIE_DIVISOR);
            return Math.round(totalKcal);
        }

        function renderWorkout() {
            const workout = getCurrentWorkoutType(selectedDay);
            const log = getLogForDay(selectedDay);
            const currentWorkoutLogs = log.workoutLogs; 
            const listContainer = document.getElementById('workout-list');
            const titleElement = document.getElementById('workout-title');
            
            listContainer.innerHTML = '';
            const totalKcal = calculateWorkoutKcal(currentWorkoutLogs);
            const genderTag = currentGender === 'male' ? 'Male' : 'Female';

            if (workout.type === 'Rest Day') {
                 titleElement.textContent = `Day ${selectedDay}: REST DAY / CARDIO`;
                 listContainer.innerHTML = '<p class="text-center text-gray-500 p-4">Focus on recovery or light cardio. Head over to the Steps tab!</p>';
                 document.getElementById('total-calories-burned').textContent = '0 kcal';
                 return;
            }

            titleElement.textContent = `Day ${selectedDay}: ${genderTag} Workout ${workout.type}`;

            let html = '';
            workout.exercises.forEach((ex) => {
                // MODIFICATION: Key must include Day and Gender for uniqueness
                const exKey = `${ex.name}_${selectedDay}_${workout.type}_${currentGender}`; 
                const exLogs = currentWorkoutLogs[exKey] || [];
                
                html += `<div class="p-3 mb-4 rounded-lg bg-gray-50 border border-gray-200">
                            <h4 class="font-bold text-gray-800 mb-2">${ex.name} <span class="text-xs font-normal text-red-500">(${ex.majorGroup})</span></h4>`;
                
                for (let i = 0; i < ex.sets; i++) {
                    const logItem = exLogs[i] || { kg: '', reps: '', done: false };
                    
                    html += `<div class="flex items-center space-x-2 mb-2">
                                <span class="w-8 font-medium text-gray-600">Set ${i + 1}:</span>
                                <input type="number" data-ex="${exKey}" data-set="${i}" data-field="kg" value="${logItem.kg}" placeholder="KG" class="w-1/4 p-2 text-center border rounded-md text-sm focus:ring-red-500" oninput="updateWorkoutLog(this)">
                                <input type="number" data-ex="${exKey}" data-set="${i}" data-field="reps" value="${logItem.reps}" placeholder="Reps" class="w-1/4 p-2 text-center border rounded-md text-sm focus:ring-red-500" oninput="updateWorkoutLog(this)">
                                <label class="flex items-center space-x-2 ml-auto cursor-pointer">
                                    <span class="text-sm">Done</span>
                                    <input type="checkbox" data-ex="${exKey}" data-set="${i}" data-field="done" ${logItem.done ? 'checked' : ''} class="w-5 h-5 text-red-600 rounded focus:ring-red-500" onclick="updateWorkoutLog(this)">
                                </label>
                            </div>`;
                }
                html += `</div>`;
            });

            listContainer.innerHTML = html;
            document.getElementById('total-calories-burned').textContent = `${totalKcal} kcal`;
        }

        window.updateWorkoutLog = (input) => {
            const log = getLogForDay(selectedDay);
            const currentWorkoutLogs = log.workoutLogs;
            
            const exKey = input.getAttribute('data-ex');
            const setIndex = parseInt(input.getAttribute('data-set'));
            const field = input.getAttribute('data-field');
            
            if (!currentWorkoutLogs[exKey]) currentWorkoutLogs[exKey] = [];
            if (!currentWorkoutLogs[exKey][setIndex]) {
                currentWorkoutLogs[exKey][setIndex] = { kg: '', reps: '', done: false };
            }
            
            if (field === 'done') {
                currentWorkoutLogs[exKey][setIndex][field] = input.checked;
            } else {
                currentWorkoutLogs[exKey][setIndex][field] = input.value;
            }

            saveAllLogs();
            // Recalculate and update the calorie count
            const totalKcal = calculateWorkoutKcal(currentWorkoutLogs);
            document.getElementById('total-calories-burned').textContent = `${totalKcal} kcal`;
            // Also update the summary view if it's the active tab
            if (document.getElementById('summary').classList.contains('active') || !document.getElementById('summary').classList.contains('hidden')) {
                renderSummary();
            }
        };


        // --- FOOD TRACKING LOGIC (No changes needed) ---

        function calculateMacroTotals(foodLog) {
            let totalC = 0, totalP = 0, totalF = 0, totalK = 0;
            foodLog.forEach(item => {
                totalK += parseInt(item.calories) || 0;
                totalP += parseInt(item.protein) || 0;
                totalC += parseInt(item.carbs) || 0;
                totalF += parseInt(item.fat) || 0;
            });
            return { totalK, totalP, totalC, totalF };
        }

        function renderFoodLog() {
            const log = getLogForDay(selectedDay);
            const foodLog = log.foodLog;
            
            const logContainer = document.getElementById('food-log');
            const totalKcal = document.getElementById('total-kcal');
            const totalProtein = document.getElementById('total-protein');
            const totalCarbs = document.getElementById('total-carbs');
            const totalFat = document.getElementById('total-fat');
            
            const totals = calculateMacroTotals(foodLog);
            
            if (foodLog.length === 0) {
                logContainer.innerHTML = '<p class="text-center text-gray-500 pt-2">No food logged yet for this day.</p>';
            } else {
                logContainer.innerHTML = foodLog.map((item, index) => {
                    const kc = parseInt(item.calories) || 0;
                    const p = parseInt(item.protein) || 0;
                    const c = parseInt(item.carbs) || 0;
                    const f = parseInt(item.fat) || 0;

                    return `<div class="flex items-center justify-between p-2 bg-white rounded-lg border">
                        <span class="font-medium text-gray-700 w-1/2 overflow-hidden text-ellipsis whitespace-nowrap">${item.name}</span>
                        <span class="text-xs text-red-500 font-bold">${kc}kcal</span>
                        <span class="text-xs text-blue-500 font-medium">${p}P</span>
                        <span class="text-xs text-green-500 font-medium">${c}C</span>
                        <span class="text-xs text-yellow-500 font-medium">${f}F</span>
                        <button onclick="deleteFoodItem(${index})" class="text-xs text-gray-400 hover:text-red-500 transition ml-2">‚ùå</button>
                    </div>`;
                }).join('');
            }
            
            totalKcal.textContent = totals.totalK;
            totalProtein.textContent = totals.totalP;
            totalCarbs.textContent = totals.totalC;
            totalFat.textContent = totals.totalF;

            // Also update the summary view if it's the active tab
            if (document.getElementById('summary').classList.contains('active') || !document.getElementById('summary').classList.contains('hidden')) {
                renderSummary();
            }
        }
        
        window.deleteFoodItem = (index) => {
            const log = getLogForDay(selectedDay);
            log.foodLog.splice(index, 1);
            saveAllLogs();
            renderFoodLog();
        }

        document.getElementById('food-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const name = document.getElementById('food-name').value.trim();
            const calories = document.getElementById('food-calories').value.trim() || 0;
            const protein = document.getElementById('food-protein').value.trim() || 0;
            const carbs = document.getElementById('food-carbs').value.trim() || 0;
            const fat = document.getElementById('food-fat').value.trim() || 0;

            if (!name) {
                showErrorModal("Please enter a name for the food item.");
                return;
            }
            
            const log = getLogForDay(selectedDay);
            log.foodLog.push({ name, calories, protein, carbs, fat });
            
            saveAllLogs();
            e.target.reset(); // Clear form
            renderFoodLog();
        });

        // --- STEPS TRACKING LOGIC (No changes needed) ---
        
        function renderStepsContent() {
            const log = getLogForDay(selectedDay);
            const stepLog = log.stepLog;
            
            const dailyStepGoal = getDailyStepGoal(selectedDay, currentGoal);
            document.getElementById('recommended-steps').textContent = `Progressive Step Goal: ${dailyStepGoal.toLocaleString()} steps`;
            
            document.getElementById('step-count').value = stepLog.steps || '';
            document.getElementById('step-calories').value = stepLog.calories || '';

             // Also update the summary view if it's the active tab
            if (document.getElementById('summary').classList.contains('active') || !document.getElementById('summary').classList.contains('hidden')) {
                renderSummary();
            }
        }

        document.getElementById('steps-form').addEventListener('submit', (e) => {
            e.preventDefault();
            let steps = parseInt(document.getElementById('step-count').value.trim()) || 0;
            let caloriesInput = document.getElementById('step-calories').value.trim();
            let calories = parseInt(caloriesInput) || 0;
            
            // Auto-calculate calories if steps > 0 and calorie input is empty
            if (steps > 0 && !caloriesInput) {
                calories = Math.round(steps * CAL_PER_STEP);
                showErrorModal(`Step Calories estimated at ${calories} kcal (based on steps * ${CAL_PER_STEP}).`);
            } else if (!steps) {
                 showErrorModal("Please enter your step count.");
                 return;
            }
            
            const log = getLogForDay(selectedDay);
            // Save the possibly auto-calculated calorie value
            log.stepLog = { steps, calories }; 
            
            saveAllLogs();
            renderStepsContent();
            showErrorModal(`Steps (${steps} steps) and calories saved for Day ${selectedDay}.`);
        });
        
        // --- SUMMARY RENDERING LOGIC (No changes needed) ---
        
        function renderSummary() {
            const log = getLogForDay(selectedDay);
            const currentGoalData = MACRO_GOALS[currentGoal];
            const dailyStepGoal = getDailyStepGoal(selectedDay, currentGoal);
            
            // 1. Get Logged Data
            const totals = calculateMacroTotals(log.foodLog);
            const workoutKcal = calculateWorkoutKcal(log.workoutLogs);
            const workoutType = getCurrentWorkoutType(selectedDay);
            const stepCount = parseInt(log.stepLog.steps) || 0;
            const stepKcal = parseInt(log.stepLog.calories) || 0;

            // 2. Calculate Goals (Macros based on Kcal goal)
            const proteinGoal = Math.round((currentGoalData.kcal * (currentGoalData.p_percent / 100)) / 4); // 4 kcal/g
            const carbsGoal = Math.round((currentGoalData.kcal * (currentGoalData.c_percent / 100)) / 4); // 4 kcal/g
            const fatGoal = Math.round((currentGoalData.kcal * (currentGoalData.f_percent / 100)) / 9); // 9 kcal/g

            // 3. Update UI - Goals
            document.getElementById('summary-goal-text').textContent = currentGoal.toUpperCase();
            document.getElementById('summary-gender-text').textContent = currentGender.toUpperCase();
            
            document.getElementById('summary-macro-goals').innerHTML = `
                <span class="text-red-500">KCAL Target: ${currentGoalData.kcal}</span>
                <span class="text-blue-500">P Target: ${proteinGoal}g</span>
                <span class="text-green-500">C Target: ${carbsGoal}g</span>
                <span class="text-yellow-500">F Target: ${fatGoal}g</span>
            `;

            // 4. Update UI - Actuals
            document.getElementById('actual-kcal').textContent = totals.totalK;
            document.getElementById('actual-protein').textContent = totals.totalP;
            document.getElementById('actual-carbs').textContent = totals.totalC;
            document.getElementById('actual-fat').textContent = totals.totalF;

            // 5. Update UI - Steps
            const stepCompletion = Math.min(100, Math.round((stepCount / dailyStepGoal) * 100));
            document.getElementById('summary-steps-actual').textContent = stepCount.toLocaleString();
            document.getElementById('summary-steps-goal').textContent = dailyStepGoal.toLocaleString();
            document.getElementById('summary-steps-kcal').textContent = `${stepKcal} kcal`;
            document.getElementById('progress-steps').style.width = `${stepCompletion}%`;
            document.getElementById('progress-steps').className = `progress-bar ${stepCompletion >= 100 ? 'bg-emerald-500' : 'bg-yellow-500'}`;

            // 6. Update UI - Workout
            document.getElementById('summary-workout-type').textContent = `Routine: ${workoutType.type === 'Rest Day' ? 'Rest Day' : `${currentGender === 'male' ? 'Male' : 'Female'} Workout ${workoutType.type}`}`;
            
            let completedSets = 0;
            let totalSets = 0;
            if (workoutType.type !== 'Rest Day') {
                 workoutType.exercises.forEach(ex => totalSets += ex.sets);
                 for (const exKey in log.workoutLogs) {
                    // Check if the log key matches the current day, workout type, and gender to ensure accuracy
                    const expectedKeyPart = `_${selectedDay}_${workoutType.type}_${currentGender}`;
                    if (log.workoutLogs.hasOwnProperty(exKey) && exKey.includes(expectedKeyPart)) {
                        log.workoutLogs[exKey].forEach(logItem => {
                            if (logItem && logItem.done) completedSets++;
                        });
                    }
                }
            }
            
            const workoutStatus = workoutType.type === 'Rest Day' 
                ? 'N/A' 
                : `${completedSets} / ${totalSets} Sets Completed`;

            document.getElementById('summary-workout-sets').textContent = `Sets: ${workoutStatus}`;
            document.getElementById('summary-workout-kcal').textContent = `${workoutKcal} kcal`;
        }
        
        // --- TAB & SNAPSHOT LOGIC ---

        function switchTab(targetId) {
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.add('hidden');
            });
            document.getElementById(targetId).classList.remove('hidden');

            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`.tab-button[data-tab="${targetId}"]`).classList.add('active');
            
            // Re-render only the relevant view on switch
            if (targetId === 'summary') renderSummary();
            if (targetId === 'exercise') renderWorkout();
            if (targetId === 'food') renderFoodLog();
            if (targetId === 'steps') renderStepsContent();
        }

        document.querySelectorAll('.tab-button').forEach(button => {
            button.addEventListener('click', (e) => {
                switchTab(e.target.getAttribute('data-tab'));
            });
        });

        window.handleSnapshot = (targetId) => {
            const targetElement = document.getElementById(targetId);
            const footer = document.getElementById('snapshot-footer');
            const snapshotDate = document.getElementById('snapshot-date');
            const mainAppDiv = document.getElementById('app'); // Get the main app container

            snapshotDate.textContent = new Date().toLocaleString();
            
            // Move footer INSIDE the element to be screenshotted
            targetElement.appendChild(footer);
            footer.classList.remove('hidden');

            html2canvas(targetElement, {
                scale: 2, 
                useCORS: true,
                logging: false,
                backgroundColor: '#ffffff'
            }).then(canvas => {
                // Move footer OUTSIDE the snapshot element
                footer.classList.add('hidden');
                mainAppDiv.appendChild(footer); // Move it back to the #app container

                const image = canvas.toDataURL('image/png');
                const link = document.createElement('a');
                const filename = `Berns100Days_${targetId}_Day${selectedDay}_${new Date().toISOString().split('T')[0]}.png`;
                link.href = image;
                link.download = filename;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }).catch(error => {
                console.error("Snapshot failed:", error);
                // Ensure the footer is moved back even on failure
                footer.classList.add('hidden');
                mainAppDiv.appendChild(footer);
                showErrorModal("Snapshot download failed. Check console for details.");
            });
        };

        function renderAll() {
            renderDaySelector();
            renderGoalTip();
            const activeTabButton = document.querySelector('.tab-button.active');
            const activeTab = activeTabButton ? activeTabButton.getAttribute('data-tab') : 'summary';
            switchTab(activeTab); 
        }
        
        // --- APP ENTRY POINT ---
        window.onload = function() {
            loadAllLogs();
            const challengeDay = getChallengeDay();
            
            // Set initial day to the current challenge day or 1 if the current day > 100
            selectedDay = Math.min(challengeDay, TOTAL_DAYS); 
            
            renderAll();
        }
    </script>
</body>
</html>