<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Bern's 100 Days Transformation</title>
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="https://via.placeholder.com/180x180/ef4444/ffffff?text=B100">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f4f7f9; }
        .tab-button.active { border-bottom: 3px solid #ef4444; color: #ef4444; }
        .day-button.active { background-color: #ef4444; color: white; }
        .snapshot-target { background-color: #ffffff; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1); }
        /* Hide default number input arrows */
        input[type="number"]::-webkit-outer-spin-button,
        input[type="number"]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type="number"] {
            -moz-appearance: textfield;
        }
        .progress-bar-container {
            width: 100%;
            background-color: #e5e7eb;
            border-radius: 9999px;
            overflow: hidden;
            height: 1rem;
        }
        .progress-bar {
            height: 100%;
            transition: width 0.3s ease-in-out;
        }
        /* Fix for iOS viewport (if needed) */
        #app {
            padding-bottom: constant(safe-area-inset-bottom);
            padding-bottom: env(safe-area-inset-bottom);
        }
    </style>
</head>
<body class="min-h-screen p-0 md:p-4">

    <div id="app" class="max-w-xl mx-auto bg-white rounded-lg shadow-2xl overflow-hidden min-h-screen md:min-h-0">
        <header class="bg-gray-800 p-4 text-white rounded-t-lg">
            <h1 class="text-2xl font-bold text-center">Bern's 100 Days Transformation</h1>
            <div id="day-counter" class="mt-2 text-lg font-semibold text-center"></div>
            
            <div class="mt-3 flex flex-wrap items-center justify-center space-x-4">
                
                <div class="flex items-center space-x-2 my-1">
                    <label for="goal-selector" class="text-sm font-medium">Goal:</label>
                    <select id="goal-selector" class="bg-white text-gray-800 text-sm rounded-md py-1 px-2 focus:ring-red-500 focus:border-red-500" onchange="updateGoal(this.value)">
                        <option value="cutting">üî™ Cutting</option>
                        <option value="bulking">üí™ Bulking</option>
                        <option value="recomp">‚ú® Recomposition</option>
                    </select>
                </div>
                
                <div class="flex items-center space-x-2 my-1">
                    <label for="gender-selector" class="text-sm font-medium">Gender:</label>
                    <select id="gender-selector" class="bg-white text-gray-800 text-sm rounded-md py-1 px-2 focus:ring-red-500 focus:border-red-500" onchange="updateGender(this.value)">
                        <option value="male">üë§ Male</option>
                        <option value="female">‚ôÄÔ∏è Female</option>
                    </select>
                </div>

            </div>
             <p id="goal-tip" class="text-xs text-center mt-2 h-4 transition-opacity duration-300"></p>
        </header>

        <div id="day-selector-container" class="w-full bg-gray-100 p-2 overflow-x-scroll whitespace-nowrap border-b border-gray-200">
            </div>

        <div class="flex border-b border-gray-200 bg-gray-50">
             <button class="tab-button flex-1 py-3 text-sm font-semibold transition duration-150 active" data-tab="summary">
                üìã Summary
            </button>
            <button class="tab-button flex-1 py-3 text-sm font-semibold transition duration-150" data-tab="exercise">
                üí™ Workout
            </button>
            <button class="tab-button flex-1 py-3 text-sm font-semibold transition duration-150" data-tab="food">
                üçé Food
            </button>
            <button class="tab-button flex-1 py-3 text-sm font-semibold transition duration-150" data-tab="steps">
                üö∂ Steps
            </button>
        </div>

        <main class="p-4 md:p-6">
            
             <div id="summary" class="tab-content">
                <div id="daily-summary-tracker" class="snapshot-target p-4 mb-6">
                    <h2 class="text-2xl font-extrabold text-gray-800 mb-4 text-center">Daily Progress Snapshot</h2>
                    <p class="text-sm text-gray-500 mb-6 text-center">Goal: <span id="summary-goal-text" class="font-bold text-red-500"></span> | Gender: <span id="summary-gender-text" class="font-bold text-indigo-500"></span></p>

                    <div class="mb-6 p-4 border rounded-lg shadow-sm">
                        <h3 class="text-xl font-bold text-emerald-600 mb-3 flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6 mr-2"><path d="M15 12a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z" /><path fill-rule="evenodd" d="M12 1.5a5.25 5.25 0 0 0-5.25 5.25v3a3 3 0 0 0-3 3v6.75a3 3 0 0 0 3 3h1.5a.75.75 0 0 0 .75-.75V15a.75.75 0 0 1 .75-.75h2.25a.75.75 0 0 1 .75.75v4.5c0 .414.336.75.75.75h1.5a3 3 0 0 0 3-3V12.75a3 3 0 0 0-3-3v-3c0-2.9-2.35-5.25-5.25-5.25Z" clip-rule="evenodd" /></svg>
                            Step Progress
                        </h3>
                        <div class="flex justify-between font-medium text-sm mb-1">
                            <span>Actual: <span id="summary-steps-actual" class="font-extrabold">0</span> steps</span>
                            <span>Goal: <span id="summary-steps-goal" class="font-extrabold text-emerald-600">0</span> steps</span>
                        </div>
                        <div class="progress-bar-container">
                            <div id="progress-steps" class="progress-bar bg-emerald-500" style="width: 0%;"></div>
                        </div>
                         <p class="text-xs text-gray-500 mt-2">Steps Cal Burn: <span id="summary-steps-kcal">0 kcal</span></p>
                    </div>

                    <div class="mb-6 p-4 border rounded-lg shadow-sm">
                        <h3 class="text-xl font-bold text-indigo-600 mb-3 flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6 mr-2"><path fill-rule="evenodd" d="M12 1.5a.75.75 0 0 1 .75.75V3h3a6 6 0 0 1 6 6v3h.75a.75.75 0 0 1 0 1.5H21v3a6 6 0 0 1-6 6h-3.75a.75.75 0 0 1-.75-.75V21h-3a6 6 0 0 1-6-6v-3H2.25a.75.75 0 0 1 0-1.5H3V9a6 6 0 0 1 6-6h3V2.25a.75.75 0 0 1 .75-.75ZM9 4.5h3A4.5 4.5 0 0 1 16.5 9v3h-1.5a.75.75 0 0 0-.75.75v3a.75.75 0 0 1-.75.75h-2.25a.75.75 0 0 1-.75-.75v-3a.75.75 0 0 0-.75-.75H7.5V9A4.5 4.5 0 0 1 12 4.5h3v1.5a.75.75 0 0 0 1.5 0V6a4.5 4.5 0 0 0-4.5-4.5h-3A4.5 4.5 0 0 0 7.5 6v3a.75.75 0 0 0 1.5 0V6a4.5 4.5 0 0 0-4.5 4.5v3a.75.75 0 0 0 1.5 0V12a.75.75 0 0 0-.75-.75h-1.5V9a4.5 4.5 0 0 1 4.5-4.5Z" clip-rule="evenodd" /></svg>
                            Workout Status
                        </h3>
                         <p id="summary-workout-type" class="text-lg font-semibold text-gray-700 mb-2"></p>
                         <p id="summary-workout-sets" class="text-sm text-gray-500 mb-2"></p>
                         <p class="text-md font-semibold text-gray-700">Estimated Kcal Burned:</p>
                         <p id="summary-workout-kcal" class="text-2xl font-extrabold text-indigo-500 mt-1">0 kcal</p>
                    </div>

                    <div class="p-4 border rounded-lg shadow-sm">
                        <h3 class="text-xl font-bold text-red-600 mb-3 flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6 mr-2"><path fill-rule="evenodd" d="M12 2.25c-5.385 0-9.75 4.365-9.75 9.75s4.365 9.75 9.75 9.75 9.75-4.365 9.75-9.75S17.385 2.25 12 2.25ZM12.75 6a.75.75 0 0 0-1.5 0v6c0 .414.336.75.75.75h4.5a.75.75 0 0 0 0-1.5h-3.75V6Z" clip-rule="evenodd" /></svg>
                            Nutrition Intake
                        </h3>
                        <div id="summary-macro-goals" class="grid grid-cols-4 gap-2 text-center text-sm font-semibold mb-3 border-b pb-2">
                             <span class="text-red-500">KCAL Target: 0</span>
                             <span class="text-blue-500">P Target: 0g</span>
                             <span class="text-green-500">C Target: 0g</span>
                             <span class="text-yellow-500">F Target: 0g</span>
                        </div>
                        <div id="summary-macro-actuals" class="grid grid-cols-4 gap-2 text-center text-sm font-bold">
                            <span class="text-gray-700">Actual KCAL: <span id="actual-kcal">0</span></span>
                            <span class="text-gray-700">Actual P: <span id="actual-protein">0</span>g</span>
                            <span class="text-gray-700">Actual C: <span id="actual-carbs">0</span>g</span>
                            <span class="text-gray-700">Actual F: <span id="actual-fat">0</span>g</span>
                        </div>
                    </div>
                </div>
                 <button onclick="handleSnapshot('daily-summary-tracker')" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 rounded-xl transition duration-300 shadow-md flex items-center justify-center">
                    Download Day Snapshot üì∏
                </button>
            </div>


            <div id="exercise" class="tab-content hidden">
                <div id="exercise-tracker" class="snapshot-target p-4 mb-6">
                    <h2 id="workout-title" class="text-xl font-bold text-gray-800 mb-4 text-center"></h2>
                    <p class="text-sm text-gray-500 mb-4 text-center">Log weight (kg) and reps for each set. Tick if completed (Progressive Overload).</p>
                    <div id="workout-list">
                        <!-- Workout fields will be rendered here -->
                    </div>
                    <div class="mt-6 pt-4 border-t border-dashed border-gray-300">
                        <p class="text-lg font-semibold text-gray-700">Total Calories Burned (Estimate):</p>
                        <p id="total-calories-burned" class="text-2xl font-extrabold text-red-500 mt-1">0 kcal</p>
                    </div>
                </div>
                <button onclick="handleSnapshot('exercise-tracker')" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 rounded-xl transition duration-300 shadow-md flex items-center justify-center">
                    Download Workout Snapshot üì∏
                </button>
            </div>

            <div id="food" class="tab-content hidden">
                <div id="food-tracker" class="snapshot-target p-4 mb-6">
                    <h2 class="text-xl font-bold text-gray-800 mb-4 text-center">Daily Food Intake</h2>
                    <form id="food-form" class="space-y-3">
                        <div>
                            <label for="food-name" class="block text-sm font-medium text-gray-700">Food Item Name (e.g., MyFitnessPal entry)</label>
                            <input type="text" id="food-name" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border focus:ring-red-500 focus:border-red-500" placeholder="e.g., Chicken Breast, 200g" required>
                        </div>
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label for="food-calories" class="block text-sm font-medium text-gray-700">Calories (kcal)</label>
                                <input type="number" id="food-calories" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border focus:ring-red-500 focus:border-red-500" placeholder="300" required>
                            </div>
                            <div>
                                <label for="food-protein" class="block text-sm font-medium text-gray-700">Protein (g)</label>
                                <input type="number" id="food-protein" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border focus:ring-red-500 focus:border-red-500" placeholder="30" required>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label for="food-carbs" class="block text-sm font-medium text-gray-700">Carbs (g)</label>
                                <input type="number" id="food-carbs" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border focus:ring-red-500 focus:border-red-500" placeholder="25" required>
                            </div>
                            <div>
                                <label for="food-fat" class="block text-sm font-medium text-gray-700">Fat (g)</label>
                                <input type="number" id="food-fat" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border focus:ring-red-500 focus:border-red-500" placeholder="10" required>
                            </div>
                        </div>
                        <button type="submit" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 rounded-lg transition duration-300 shadow-md">
                            Add Meal/Food
                        </button>
                    </form>

                    <div class="mt-6">
                        <h3 class="text-lg font-bold text-gray-800 border-b pb-2 mb-2">Selected Day's Log</h3>
                        <div id="food-log" class="space-y-2 text-sm">
                            </div>
                        <div class="mt-4 pt-2 border-t border-dashed border-gray-300">
                            <p class="text-md font-semibold text-gray-700">Daily Totals:</p>
                            <div class="grid grid-cols-4 gap-2 text-center text-xs mt-1 font-bold">
                                <p class="text-red-500">KCAL: <span id="total-kcal">0</span></p>
                                <p class="text-blue-500">P: <span id="total-protein">0</span>g</p>
                                <p class="text-green-500">C: <span id="total-carbs">0</span>g</p>
                                <p class="text-yellow-500">F: <span id="total-fat">0</span>g</p>
                            </div>
                        </div>
                    </div>
                </div>
                <button onclick="handleSnapshot('food-tracker')" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 rounded-xl transition duration-300 shadow-md flex items-center justify-center">
                    Download Food Snapshot üì∏
                </button>
            </div>

            <div id="steps" class="tab-content hidden">
                <div id="steps-tracker" class="snapshot-target p-4 mb-6 text-center">
                    <h2 class="text-xl font-bold text-gray-800 mb-4">Daily Step Count</h2>
                    <p class="text-sm text-gray-500 mb-4">Log your total steps and the calories estimated by your device (or let us calculate it).</p>
                    <p id="recommended-steps" class="text-lg font-semibold text-emerald-600 mb-4"></p>
                    <form id="steps-form" class="space-y-4 max-w-sm mx-auto">
                        <div>
                            <label for="step-count" class="block text-lg font-medium text-gray-700">Total Steps Logged</label>
                            <input type="number" id="step-count" class="mt-1 block w-full text-center text-xl rounded-md border-gray-300 shadow-sm p-3 border focus:ring-red-500 focus:border-red-500" placeholder="e.g., 10000" required>
                        </div>
                        <div>
                            <label for="step-calories" class="block text-lg font-medium text-gray-700">Calories Burned (Estimated)</label>
                            <input type="number" id="step-calories" class="mt-1 block w-full text-center text-xl rounded-md border-gray-300 shadow-sm p-3 border focus:ring-red-500 focus:border-red-500" placeholder="e.g., 500 (Optional)">
                        </div>
                        <button type="submit" class="w-full bg-emerald-500 hover:bg-emerald-600 text-white font-bold py-3 rounded-xl transition duration-300 shadow-md">
                            Log Steps
                        </button>
                    </form>
                </div>
                <button onclick="handleSnapshot('steps-tracker')" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 rounded-xl transition duration-300 shadow-md flex items-center justify-center">
                    Download Steps Snapshot üì∏
                </button>
            </div>
        </main>
    </div>

    <div id="snapshot-footer" class="hidden text-xs text-gray-500 text-center w-full py-1 bg-gray-100 rounded-b-lg">
        Snapshot taken on <span id="snapshot-date"></span>
    </div>
    
    <div id="error-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white p-6 rounded-xl shadow-2xl max-w-sm w-full text-center">
            <h3 class="text-xl font-bold text-red-600 mb-4">Tracker Message</h3>
            <p id="error-message" class="text-gray-700 mb-6"></p>
            <button onclick="document.getElementById('error-modal').classList.add('hidden'); document.getElementById('error-modal').classList.remove('flex')" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg transition">
                Acknowledge & Continue
            </button>
        </div>
    </div>

    <script>
        // --- GLOBAL VARIABLES & CONSTANTS ---
        const DAY_COUNTER_KEY = 'berns100DaysStartDate';
        const GOAL_KEY = 'bernsCurrentGoal';
        const GENDER_KEY = 'bernsUserGender'; 
        const ALL_LOGS_KEY = 'bernsAll100DayLogs'; 
        const TOTAL_DAYS = 100;
        const EXERCISE_CALORIE_MULTIPLIER = 12; // Base kcal per set
        const WEIGHT_CALORIE_DIVISOR = 6;       // Bonus kcal per kg lifted
        const CAL_PER_STEP = 0.045;             // Estimated kcal per step

        let selectedDay = 1; 
        let allDailyLogs = {}; 
        let currentGoal = localStorage.getItem(GOAL_KEY) || 'cutting';
        let currentGender = localStorage.getItem(GENDER_KEY) || 'male'; 
        const todayKey = new Date().toISOString().split('T')[0]; 

        // New Consistency/Progression Phase constants
        const BASELINE_STEPS = 6000;
        const BASELINE_DAYS = 10;
        const PROGRESSION_DAYS = TOTAL_DAYS - BASELINE_DAYS; 

        // Goal based step targets
        const RECOMMENDED_STEPS = {
            cutting: 12000,
            bulking: 8000,
            recomp: 10000 
        };

        // Placeholder macro/calorie goals for the Summary tab
        const MACRO_GOALS = {
            cutting: { kcal: 2000, p_percent: 40, c_percent: 35, f_percent: 25 },
            bulking: { kcal: 3000, p_percent: 30, c_percent: 45, f_percent: 25 },
            recomp: { kcal: 2500, p_percent: 35, c_percent: 40, f_percent: 25 }
        };

        const GOAL_TIPS = {
            cutting: "üî™ **CUTTING:** Focus on **high protein** intake and a **calorie deficit** to preserve muscle while losing fat.",
            bulking: "üí™ **BULKING:** Ensure a consistent **calorie surplus** and fuel workouts with **carbs and protein** for maximal muscle growth.",
            recomp: "‚ú® **RECOMP:** Maintain calories and **maximize protein**. Eat slightly higher on workout days and lower on rest days."
        };
        
        // Define the common abs exercises once
        const ABS_EXERCISES = [
            { name: "Crunches / Leg Raises", sets: 3, majorGroup: "Abs/Core" },
            { name: "Plank (30-60s hold)", sets: 3, majorGroup: "Core Stability" }
        ];

        // --- MALE Workout Definitions (Lazy Lifter A/B/C Split) ---
        const WORKOUTS_MALE = {
            A: [
                { name: "Barbell Squat", sets: 3, majorGroup: "Heavy Lower" },
                { name: "Barbell Bench Press", sets: 3, majorGroup: "Horizontal Press" },
                { name: "Barbell Bent-Over Row", sets: 3, majorGroup: "Back Thickness" },
                { name: "Overhead Dumbbell Triceps Extension", sets: 3, majorGroup: "Triceps Accessory" },
                { name: "Hanging Leg Raise", sets: 3, majorGroup: "Core" }
            ],
            B: [
                { name: "Deadlift", sets: 3, majorGroup: "Heavy Hinge" },
                { name: "Barbell Overhead Press", sets: 3, majorGroup: "Vertical Press" },
                { name: "Lat Pulldown / Pull-up", sets: 3, majorGroup: "Back Width" },
                { name: "Dumbbell Walking Lunge", sets: 3, majorGroup: "Legs Volume" },
                { name: "Dumbbell Biceps Curl", sets: 3, majorGroup: "Biceps Accessory" }
            ],
            C: [
                { name: "Incline Dumbbell Press", sets: 3, majorGroup: "Chest Volume" },
                { name: "Seated Cable Row", sets: 3, majorGroup: "Back Volume" },
                { name: "Leg Press / Hack Squat", sets: 3, majorGroup: "Lower Volume" },
                { name: "Side Lateral Raise (DB)", sets: 3, majorGroup: "Shoulder Isolation" },
                { name: "Face Pulls", sets: 3, majorGroup: "Shoulder Health" }
            ]
        };

        // --- FEMALE Workout Definitions (Lazy Lifter A/B/C Split - Glute/Hip Focus) ---
        const WORKOUTS_FEMALE = {
            A: [
                { name: "Barbell Squat", sets: 3, majorGroup: "Heavy Quads/Glutes" },
                { name: "Dumbbell Bench Press", sets: 3, majorGroup: "Upper Body Press" },
                { name: "Barbell Row (Supported)", sets: 3, majorGroup: "Back Thickness" },
                { name: "Barbell Hip Thrusts", sets: 3, majorGroup: "Heavy Glute Isolation" },
                { name: "Lateral Raises (DB)", sets: 3, majorGroup: "Shoulder Isolation" }
            ],
            B: [
                { name: "Romanian Deadlifts (RDL)", sets: 3, majorGroup: "Hamstrings/Glutes Hinge" },
                { name: "Lat Pulldown", sets: 3, majorGroup: "Back Width" },
                { name: "Seated Overhead Press (DB)", sets: 3, majorGroup: "Shoulder Press" },
                { name: "Leg Extension / Curl (Superset)", sets: 3, majorGroup: "Legs Isolation" },
                { name: "Triceps Pushdown", sets: 3, majorGroup: "Triceps Accessory" }
            ],
            C: [
                { name: "Cable Glute Kickbacks (per leg)", sets: 3, majorGroup: "Glute Volume" },
                { name: "Split Squats (DB/Barbell)", sets: 3, majorGroup: "Legs Unilateral" },
                { name: "Single-Arm Dumbbell Row", sets: 3, majorGroup: "Back Volume" },
                { name: "Shoulder Press Machine", sets: 3, majorGroup: "Shoulder Volume" },
                { name: "Calf Raises / Ab Crunches", sets: 3, majorGroup: "Accessory/Core" }
            ]
        };

        // --- UTILITIES & LOCAL STORAGE MANAGEMENT ---
        
        function showErrorModal(message) {
            document.getElementById('error-message').innerHTML = message;
            document.getElementById('error-modal').classList.remove('hidden');
            document.getElementById('error-modal').classList.add('flex');
        }
        window.showErrorModal = showErrorModal;

        function saveAllLogs() {
            try {
                localStorage.setItem(ALL_LOGS_KEY, JSON.stringify(allDailyLogs));
            } catch (e) {
                console.error("Error saving all 100-day data:", e);
                showErrorModal("Failed to save data locally. Your browser storage may be full or disabled.");
            }
        }

        function loadAllLogs() {
            try {
                allDailyLogs = JSON.parse(localStorage.getItem(ALL_LOGS_KEY) || '{}');
            } catch (e) {
                console.error("Error loading all 100-day data:", e);
                showErrorModal("Failed to load all challenge logs. Resetting the tracker data.");
                allDailyLogs = {};
            }
        }

        function getLogForDay(day) {
            const dayStr = day.toString();
            if (!allDailyLogs[dayStr]) {
                allDailyLogs[dayStr] = {
                    foodLog: [], 
                    stepLog: { steps: '', calories: '' }, 
                    workoutLogs: {} // key: 'exName_day_type_gender', value: [{kg, reps, done}, ...]
                };
            }
            return allDailyLogs[dayStr];
        }

        /**
         * Calculates the progressive step goal for a given day using a two-phase model.
         */
        function getDailyStepGoal(day, goal) {
            const finalGoalSteps = RECOMMENDED_STEPS[goal];

            // Phase 1: Habit Formation (Days 1 to 10) - Fixed Goal
            if (day <= BASELINE_DAYS) {
                return BASELINE_STEPS;
            }
            
            // Phase 2: Progressive Overload (Days 11 to 100) - Linear Increase
            if (day > BASELINE_DAYS && day <= TOTAL_DAYS) {
                const startProgression = BASELINE_STEPS;
                const totalIncrease = finalGoalSteps - startProgression; 
                const daysIntoProgression = day - BASELINE_DAYS; 
                
                // Linear interpolation over the 90 progression days
                let target = startProgression + (totalIncrease * (daysIntoProgression / PROGRESSION_DAYS));
                
                return Math.round(target / 100) * 100; // Round to nearest 100
            }
            
            // If day > 100, return the final goal
            return finalGoalSteps;
        }


        // --- DAY SELECTION & 100 DAY LOGIC ---

        function getChallengeDay() {
            let startDateStr = localStorage.getItem(DAY_COUNTER_KEY);
            
            if (!startDateStr) {
                startDateStr = todayKey;
                localStorage.setItem(DAY_COUNTER_KEY, startDateStr);
            }
            
            const today = new Date();
            today.setHours(0, 0, 0, 0); 
            
            let startDate = new Date(startDateStr);
            startDate.setHours(0, 0, 0, 0); 

            if (isNaN(startDate.getTime())) {
                startDate = today;
                startDateStr = todayKey;
                localStorage.setItem(DAY_COUNTER_KEY, startDateStr);
                showErrorModal("The challenge start date was corrupted. It has been automatically reset to today's date.");
            }

            const diffTime = today.getTime() - startDate.getTime();
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            
            return Math.min(diffDays + 1, TOTAL_DAYS);
        }

        function renderDaySelector() {
            const selectorContainer = document.getElementById('day-selector-container');
            selectorContainer.innerHTML = '';
            
            const challengeDay = getChallengeDay();
            const displayDate = new Date().toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
            
            if (challengeDay > TOTAL_DAYS) {
                document.getElementById('day-counter').innerHTML = `üéâ **100 Day Challenge Completed!**`;
            } else {
                document.getElementById('day-counter').innerHTML = `üìÖ ${displayDate} | **Challenge Day ${challengeDay}**`;
            }
            
            // Generate 100 buttons
            for (let day = 1; day <= TOTAL_DAYS; day++) {
                const button = document.createElement('button');
                button.textContent = `Day ${day}`;
                button.setAttribute('data-day', day);
                button.className = `day-button text-xs px-3 py-1 m-1 rounded-full font-semibold border border-gray-300 transition duration-150 ${day === selectedDay ? 'active' : 'bg-white text-gray-700 hover:bg-gray-200'}`;
                button.onclick = () => selectDay(day);
                selectorContainer.appendChild(button);
            }
            
            const activeDayButton = selectorContainer.querySelector(`[data-day="${selectedDay}"]`);
            if (activeDayButton) {
                activeDayButton.scrollIntoView({ behavior: 'smooth', inline: 'center', block: 'nearest' });
            }
        }

        window.selectDay = (day) => {
            selectedDay = day;
            renderAll();
        }


        // --- GOAL & GENDER SETTINGS ---
        window.updateGoal = (goal) => {
            currentGoal = goal;
            localStorage.setItem(GOAL_KEY, currentGoal);
            renderGoalTip();
            renderAll(); 
        };
        
        window.updateGender = (gender) => {
            currentGender = gender;
            localStorage.setItem(GENDER_KEY, currentGender);
            renderAll();
            showErrorModal(`Workout routine set to **${gender.toUpperCase()}** split.`);
        };

        function renderGoalTip() {
            document.getElementById('goal-selector').value = currentGoal;
            document.getElementById('gender-selector').value = currentGender;
            document.getElementById('goal-tip').innerHTML = GOAL_TIPS[currentGoal];
        }

        // --- EXERCISE TRACKING LOGIC ---

        function getCurrentWorkoutType(day) {
            // Lazy Lifter A/B/C rotation (3x/week schedule: A, Rest, B, Rest, C, Rest, Rest)
            const cycleDay = (day - 1) % 7; // 0 to 6

            // Defines the rotation sequence: A/R/B/R/C/R/R
            const schedule = ['A', 'R', 'B', 'R', 'C', 'R', 'R'];
            const workoutKey = schedule[cycleDay];

            if (workoutKey === 'R') {
                return { type: 'Rest Day (R)', exercises: [] };
            }

            const routine = (currentGender === 'male') ? WORKOUTS_MALE : WORKOUTS_FEMALE;
            // Include core exercises for all lifting days (A, B, C)
            const liftExercises = [...routine[workoutKey], ...ABS_EXERCISES];

            return {
                type: `Workout ${workoutKey}`,
                exercises: liftExercises
            };
        }

        function calculateWorkoutKcal(workoutLogs) {
            let totalKcal = 0;
            let totalSetsCompleted = 0;
            let totalWeightLifted = 0;

            for (const exKey in workoutLogs) {
                if (workoutLogs.hasOwnProperty(exKey)) {
                    // Filter out non-lifting days where the key might be missing but loop runs
                    if (WORKOUTS_MALE.hasOwnProperty(exKey.charAt(9)) || WORKOUTS_FEMALE.hasOwnProperty(exKey.charAt(9))) {
                        workoutLogs[exKey].forEach(logItem => {
                            if (logItem && logItem.done) {
                                totalSetsCompleted++;
                                const weight = parseFloat(logItem.kg) || 0;
                                const reps = parseInt(logItem.reps) || 0;
                                totalWeightLifted += weight * reps;
                            }
                        });
                    }
                }
            }

            totalKcal = (totalSetsCompleted * EXERCISE_CALORIE_MULTIPLIER) + (totalWeightLifted / WEIGHT_CALORIE_DIVISOR);
            return Math.round(totalKcal);
        }

        function saveWorkoutLog(exKey, setIndex, field, value) {
            const log = getLogForDay(selectedDay);
            if (!log.workoutLogs[exKey]) {
                log.workoutLogs[exKey] = [];
            }
            
            // Initialize the set log if it doesn't exist
            if (!log.workoutLogs[exKey][setIndex]) {
                log.workoutLogs[exKey][setIndex] = { kg: '', reps: '', done: false };
            }

            // Update the specific field
            if (field === 'done') {
                log.workoutLogs[exKey][setIndex].done = value;
            } else {
                log.workoutLogs[exKey][setIndex][field] = value;
            }

            saveAllLogs();
            renderSummary(); // Update Kcal calculation immediately
        }

        function renderWorkout() {
            const workout = getCurrentWorkoutType(selectedDay);
            const log = getLogForDay(selectedDay);
            const currentWorkoutLogs = log.workoutLogs; 
            const listContainer = document.getElementById('workout-list');
            const titleElement = document.getElementById('workout-title');
            
            listContainer.innerHTML = '';
            const totalKcal = calculateWorkoutKcal(currentWorkoutLogs);
            const genderTag = currentGender === 'male' ? 'Male' : 'Female';

            if (workout.type === 'Rest Day (R)') {
                 titleElement.textContent = `Day ${selectedDay}: REST DAY / CARDIO (R)`;
                 listContainer.innerHTML = '<p class="text-center text-gray-500 p-4 font-semibold">Today is a scheduled REST or CARDIO day. Focus on getting your steps in! (See Steps Tab)</p>';
                 document.getElementById('total-calories-burned').textContent = '0 kcal';
                 return;
            }

            titleElement.textContent = `Day ${selectedDay}: ${genderTag} ${workout.type}`;

            let html = '';
            workout.exercises.forEach((ex) => {
                // Key includes Day and Gender for uniqueness: exName_DayX_WorkoutY_GenderZ
                const exKey = `${ex.name.replace(/[^a-zA-Z0-9]/g, '')}_${selectedDay}_${workout.type.replace('Workout ', '')}_${currentGender}`; 
                const exLogs = currentWorkoutLogs[exKey] || [];
                
                html += `<div class="p-3 mb-4 rounded-lg bg-gray-50 border border-gray-200">
                    <h3 class="font-bold text-base text-gray-800">${ex.name}</h3>
                    <p class="text-xs text-red-500 mb-2">${ex.majorGroup} (${ex.sets} sets)</p>
                `;

                for (let i = 0; i < ex.sets; i++) {
                    const setLog = exLogs[i] || { kg: '', reps: '', done: false };
                    
                    html += `
                        <div class="flex items-center space-x-2 py-1 border-t border-gray-100">
                            <span class="text-xs font-semibold w-8 text-gray-600">Set ${i + 1}</span>
                            
                            <input type="number" 
                                class="w-1/3 px-2 py-1 text-sm border rounded focus:ring-red-500" 
                                placeholder="Weight (kg)" 
                                value="${setLog.kg}"
                                oninput="saveWorkoutLog('${exKey}', ${i}, 'kg', this.value)"
                            >
                            <input type="number" 
                                class="w-1/4 px-2 py-1 text-sm border rounded focus:ring-red-500" 
                                placeholder="Reps" 
                                value="${setLog.reps}"
                                oninput="saveWorkoutLog('${exKey}', ${i}, 'reps', this.value)"
                            >
                            <label class="flex items-center space-x-1 ml-auto">
                                <input type="checkbox" 
                                    class="h-4 w-4 text-red-600 border-gray-300 rounded focus:ring-red-500"
                                    ${setLog.done ? 'checked' : ''}
                                    onchange="saveWorkoutLog('${exKey}', ${i}, 'done', this.checked)"
                                >
                                <span class="text-xs text-gray-600">Done</span>
                            </label>
                        </div>
                    `;
                }
                html += `</div>`;
            });

            listContainer.innerHTML = html;
            document.getElementById('total-calories-burned').textContent = `${totalKcal} kcal`;
        }

        // --- FOOD TRACKING LOGIC ---

        function renderFood() {
            const log = getLogForDay(selectedDay);
            const foodLogContainer = document.getElementById('food-log');
            
            let totalKcal = 0, totalProtein = 0, totalCarbs = 0, totalFat = 0;
            
            if (log.foodLog.length === 0) {
                foodLogContainer.innerHTML = '<p class="text-gray-500 text-center py-4">No food logged for this day yet.</p>';
            } else {
                foodLogContainer.innerHTML = log.foodLog.map((item, index) => {
                    totalKcal += parseFloat(item.calories) || 0;
                    totalProtein += parseFloat(item.protein) || 0;
                    totalCarbs += parseFloat(item.carbs) || 0;
                    totalFat += parseFloat(item.fat) || 0;
                    
                    return `
                        <div class="bg-white p-3 border rounded-lg flex justify-between items-center shadow-sm">
                            <div>
                                <p class="font-semibold text-gray-800">${item.name}</p>
                                <p class="text-xs text-gray-500">${item.calories} kcal | P:${item.protein}g | C:${item.carbs}g | F:${item.fat}g</p>
                            </div>
                            <button onclick="deleteFoodItem(${index})" class="text-red-500 hover:text-red-700 text-lg">
                                &times;
                            </button>
                        </div>
                    `;
                }).join('');
            }
            
            document.getElementById('total-kcal').textContent = Math.round(totalKcal);
            document.getElementById('total-protein').textContent = Math.round(totalProtein);
            document.getElementById('total-carbs').textContent = Math.round(totalCarbs);
            document.getElementById('total-fat').textContent = Math.round(totalFat);
        }

        function deleteFoodItem(index) {
            const log = getLogForDay(selectedDay);
            log.foodLog.splice(index, 1);
            saveAllLogs();
            renderFood();
            renderSummary(); 
        }

        document.getElementById('food-form').onsubmit = function(e) {
            e.preventDefault();
            const log = getLogForDay(selectedDay);
            
            const newFoodItem = {
                name: document.getElementById('food-name').value.trim(),
                calories: document.getElementById('food-calories').value,
                protein: document.getElementById('food-protein').value,
                carbs: document.getElementById('food-carbs').value,
                fat: document.getElementById('food-fat').value,
            };

            log.foodLog.push(newFoodItem);
            saveAllLogs();
            
            // Clear form
            this.reset();
            renderFood();
            renderSummary(); 
        };

        // --- STEPS TRACKING LOGIC ---

        function renderSteps() {
            const log = getLogForDay(selectedDay);
            const stepGoal = getDailyStepGoal(selectedDay, currentGoal);
            
            document.getElementById('recommended-steps').textContent = `Target Steps: ${stepGoal.toLocaleString()} steps`;
            document.getElementById('step-count').value = log.stepLog.steps;
            document.getElementById('step-calories').value = log.stepLog.calories;
        }

        document.getElementById('steps-form').onsubmit = function(e) {
            e.preventDefault();
            const log = getLogForDay(selectedDay);
            
            const steps = parseInt(document.getElementById('step-count').value) || 0;
            let calories = parseInt(document.getElementById('step-calories').value) || 0;

            // If user did not provide calories, calculate an estimate
            if (!calories) {
                calories = Math.round(steps * CAL_PER_STEP);
                // Update the field to show the estimated value
                document.getElementById('step-calories').value = calories;
            }

            log.stepLog.steps = steps;
            log.stepLog.calories = calories;

            saveAllLogs();
            showErrorModal(`Steps logged: ${steps.toLocaleString()} steps (${calories} kcal).`);
            renderSummary();
        };

        // --- SUMMARY LOGIC ---

        function renderSummary() {
            const log = getLogForDay(selectedDay);
            const foodTotal = log.foodLog.reduce((acc, item) => ({
                kcal: acc.kcal + (parseFloat(item.calories) || 0),
                protein: acc.protein + (parseFloat(item.protein) || 0),
                carbs: acc.carbs + (parseFloat(item.carbs) || 0),
                fat: acc.fat + (parseFloat(item.fat) || 0),
            }), { kcal: 0, protein: 0, carbs: 0, fat: 0 });

            const workoutKcal = calculateWorkoutKcal(log.workoutLogs);
            const stepKcal = parseInt(log.stepLog.calories) || 0;
            const stepActual = parseInt(log.stepLog.steps) || 0;
            const stepGoal = getDailyStepGoal(selectedDay, currentGoal);

            const workout = getCurrentWorkoutType(selectedDay);
            
            // Macro Goals Calculation (Based on percentage of goal KCAL)
            const goalConfig = MACRO_GOALS[currentGoal];
            const goalKcal = goalConfig.kcal;
            // 1g Protein/Carb = 4kcal, 1g Fat = 9kcal
            const goalProtein = Math.round((goalKcal * goalConfig.p_percent / 100) / 4);
            const goalCarbs = Math.round((goalKcal * goalConfig.c_percent / 100) / 4);
            const goalFat = Math.round((goalKcal * goalConfig.f_percent / 100) / 9);

            // Populate Macro Goals
            document.getElementById('summary-macro-goals').innerHTML = `
                 <span class="text-red-500">KCAL Target: ${goalKcal}</span>
                 <span class="text-blue-500">P Target: ${goalProtein}g</span>
                 <span class="text-green-500">C Target: ${goalCarbs}g</span>
                 <span class="text-yellow-500">F Target: ${goalFat}g</span>
            `;

            // Populate Macro Actuals
            document.getElementById('actual-kcal').textContent = Math.round(foodTotal.kcal);
            document.getElementById('actual-protein').textContent = Math.round(foodTotal.protein);
            document.getElementById('actual-carbs').textContent = Math.round(foodTotal.carbs);
            document.getElementById('actual-fat').textContent = Math.round(foodTotal.fat);
            
            // Populate Workout Status
            document.getElementById('summary-workout-type').textContent = `${workout.type}`;
            document.getElementById('summary-workout-sets').textContent = (workout.type === 'Rest Day (R)') 
                ? 'Scheduled for Active Recovery / Steps.' 
                : `${workout.exercises.length} Exercises Scheduled.`;
            document.getElementById('summary-workout-kcal').textContent = `${workoutKcal} kcal`;

            // Populate Step Progress
            document.getElementById('summary-steps-actual').textContent = stepActual.toLocaleString();
            document.getElementById('summary-steps-goal').textContent = stepGoal.toLocaleString();
            document.getElementById('summary-steps-kcal').textContent = `${stepKcal} kcal`;

            const stepPercent = Math.min(100, Math.round((stepActual / stepGoal) * 100));
            document.getElementById('progress-steps').style.width = `${stepPercent}%`;

            // Goal/Gender Headers
            document.getElementById('summary-goal-text').textContent = currentGoal.charAt(0).toUpperCase() + currentGoal.slice(1);
            document.getElementById('summary-gender-text').textContent = currentGender.charAt(0).toUpperCase() + currentGender.slice(1);
        }

        // --- TAB SWITCHING & RENDERING ---

        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.add('hidden');
            });
            document.getElementById(tabName).classList.remove('hidden');

            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('active');
            });
            document.querySelector(`.tab-button[data-tab="${tabName}"]`).classList.add('active');
            
            // Call the corresponding render function
            if (tabName === 'summary') renderSummary();
            if (tabName === 'exercise') renderWorkout();
            if (tabName === 'food') renderFood();
            if (tabName === 'steps') renderSteps();
        }

        document.querySelectorAll('.tab-button').forEach(button => {
            button.addEventListener('click', () => switchTab(button.getAttribute('data-tab')));
        });

        function renderAll() {
            loadAllLogs(); 
            renderGoalTip();
            renderDaySelector();
            
            document.querySelectorAll('.day-button').forEach(button => {
                button.classList.remove('active');
                if (parseInt(button.getAttribute('data-day')) === selectedDay) {
                    button.classList.add('active');
                }
            });

            // Re-render the active tab
            const activeTab = document.querySelector('.tab-button.active')?.getAttribute('data-tab') || 'summary';
            switchTab(activeTab);
        }
        
        // --- SCREENSHOT LOGIC ---
        window.handleSnapshot = async (elementId) => {
            const element = document.getElementById(elementId);
            const date = new Date().toLocaleString();

            const footer = document.getElementById('snapshot-footer');
            document.getElementById('snapshot-date').textContent = date;
            
            const originalPadding = element.style.padding;
            const originalBg = element.style.backgroundColor;

            // Temporarily adjust for better screenshot
            element.style.padding = '20px';
            element.style.backgroundColor = 'white'; 
            footer.classList.remove('hidden');
            
            try {
                const canvas = await html2canvas(element, {
                    scale: 2, 
                    useCORS: true,
                    allowTaint: true,
                });

                // Create download link
                const image = canvas.toDataURL('image/png');
                const link = document.createElement('a');
                link.href = image;
                link.download = `Berns100Day_Day${selectedDay}_${elementId}.png`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                showErrorModal("Snapshot downloaded successfully! Check your downloads folder.");

            } catch (error) {
                console.error('Screenshot failed:', error);
                showErrorModal('Failed to generate snapshot. Try refreshing the page or checking console for errors.');
            } finally {
                // Restore original styles
                element.style.padding = originalPadding;
                element.style.backgroundColor = originalBg;
                footer.classList.add('hidden');
            }
        };

        // --- INITIALIZATION ---
        window.onload = function() {
            // Set the selected day to the current challenge day on load
            selectedDay = getChallengeDay();
            renderAll();
        };

    </script>
</body>
</html>
